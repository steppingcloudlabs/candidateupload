const _log = require('../../_runtime/common/error/log')
const { normalizeError } = require('../../_runtime/common/error/frontend')

module.exports = () => {
  return function rest_error(err, req, res, next) {
    if (err == 401 || err.code == 401) return next(err) // speed up logins, at least temporary until we reviewed and eliminated overhead that may be involved below

    // REVISIT: keep?
    // log the error (4xx -> warn)
    _log(err)

    const { error, statusCode } = normalizeError(err, req)

    // NOTE: express also looks for numbers in err.status or err.statusCode
    error.statusCode = statusCode

    next(error)
  }
}
