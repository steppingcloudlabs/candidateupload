// REVISIT: I think we can remove this file. Log output doesn't need localization.
// REVISIT: We should remove the i18n machinery from log output.
const cds = require('../../cds')
const LOG = cds.log()

const { isClientError } = require('./frontend')

// REVISIT: Where is that being used...?
module.exports = err => {
  // REVISIT: how does level behave compared to _log in (legacy) odata adapter?
  const level = isClientError(err) ? 'warn' : 'error'
  if ((level === 'warn' && !LOG._warn) || (level === 'error' && !LOG._error)) return

  // replace messages in toLog with developer texts (i.e., undefined locale)
  const _message = err.message
  const _details = err.details
  // REVISIT: We shouldn't run log output thru i18n machinery at all!
  err.message = cds.i18n.messages.at(err.message || err.code, '', err.args) || err.message
  if (err.details) {
    const details = []
    for (const d of err.details) {
      details.push(
        Object.assign({}, d, { message: cds.i18n.messages.at(d.message || d.code, '', d.args) || d.message })
      )
    }
    err.details = details
  }

  // log it
  LOG[level](err)

  // restore
  err.message = _message
  if (_details) err.details = _details
}
